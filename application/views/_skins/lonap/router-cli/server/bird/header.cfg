{*
    LONAP Bird Route Server Configuration Templates

    Please see: https://github.com/inex/IXP-Manager/wiki/Route-Server
    Skinning: https://github.com/inex/IXP-Manager/wiki/Skinning

*}

# LONAP Bird Route Server configuration generated by IXP Manager
#
# DO NOT edit this file, it will be overwritten. Please see:
#
# https://github.com/inex/IXP-Manager/wiki/Route-Server
#
# Generated: {$smarty.now|date_format:'Y-m-d H:i:s'}
#

# For VLAN: {$vlan->getName()} (Tag: {$vlan->getNumber()}, Database ID: {$vlan->getId()})

router id {#rsconfRouterID#};

# Log to syslog only:
# log "{#rsconfLogfile#}" all;
log syslog all;

# ignore interface up/down events
protocol device {
}

protocol direct {
        disabled;
}

# Comment 'disabled' if you want to have learned routes in UNIX routing table
protocol kernel {
       disabled;
       import all;             # Default is import all
       export all;             # Default is export none
       scan time 10;           # Scan kernel tables every 10 seconds
}

define routeserverasn = {#rsconfASN#};

{if $proto eq 6}
listen bgp v6only;
{else}
listen bgp address {#rsconfListenAddr#};
define routeserveraddress = {#rsconfListenAddr#};
{/if}


# This function excludes weird networks
#  rfc1918, class D, class E, too long and too short prefixes
function avoid_martians()
prefix set martians;
{
    {if $proto eq 6}

        martians = [
                ::/0,                   # Default (can be advertised as a route in BGP to peers if desired)
                ::/96,                  # IPv4-compatible IPv6 address <E2><80><93> deprecated by RFC4291
                ::/128,                 # Unspecified address
                ::1/128,                # Local host loopback address
                ::ffff:0.0.0.0/96+,     # IPv4-mapped addresses
                ::224.0.0.0/100+,       # Compatible address (IPv4 format)
                ::127.0.0.0/104+,       # Compatible address (IPv4 format)
                ::0.0.0.0/104+,         # Compatible address (IPv4 format)
                ::255.0.0.0/104+,       # Compatible address (IPv4 format)
                0000::/8+,              # Pool used for unspecified, loopback and embedded IPv4 addresses
                0200::/7+,              # OSI NSAP-mapped prefix set (RFC4548) <E2><80><93> deprecated by RFC4048
                3ffe::/16+,             # Former 6bone, now decommissioned
                2001:db8::/32+,         # Reserved by IANA for special purposes and documentation
                2002:e000::/20+,        # Invalid 6to4 packets (IPv4 multicast)
                2002:7f00::/24+,        # Invalid 6to4 packets (IPv4 loopback)
                2002:0000::/24+,        # Invalid 6to4 packets (IPv4 default)
                2002:ff00::/24+,        # Invalid 6to4 packets
                2002:0a00::/24+,        # Invalid 6to4 packets (IPv4 private 10.0.0.0/8 network)
                2002:ac10::/28+,        # Invalid 6to4 packets (IPv4 private 172.16.0.0/12 network)
                2002:c0a8::/32+,        # Invalid 6to4 packets (IPv4 private 192.168.0.0/16 network)
                fc00::/7+,              # Unicast Unique Local Addresses (ULA) <E2><80><93> RFC 4193
                fe80::/10+,             # Link-local Unicast
                fec0::/10+,             # Site-local Unicast <E2><80><93> deprecated by RFC 3879 (replaced by ULA)
                ff00::/8+               # Multicast
        ];

     {else}

        martians = [
                10.0.0.0/8+,
                169.254.0.0/16+,
                172.16.0.0/12+,
                192.0.0.0/24+,
                192.0.2.0/24+,
                192.168.0.0/16+,
                198.18.0.0/15+,
                198.51.100.0/24+,
                203.0.113.0/24+,
                224.0.0.0/4+,
                240.0.0.0/4+,
                0.0.0.0/32-,
                0.0.0.0/0{ldelim}25,32{rdelim},
                0.0.0.0/0{ldelim}0,7{rdelim}
        ];

     {/if}

        # Avoid RFC1918 and similar networks
        if net ~ martians then
                return false;

        return true;
}

##
## Standard IXP community filter
##

function bgp_out(int peerasn)
{

        if ! (source = RTS_BGP ) then return false;
        if peerasn > 65535 then
        {
                if (ro,0,peerasn) ~ bgp_ext_community then return false;
                if (ro,routeserverasn,peerasn) ~ bgp_ext_community then return true;
                if (ro,0,routeserverasn) ~ bgp_ext_community then return false;
        } else {
                if (0,peerasn) ~ bgp_community || ((ro,0,peerasn) ~ bgp_ext_community) then return false;
                if ((routeserverasn,peerasn) ~ bgp_community) || ((ro,routeserverasn,peerasn) ~ bgp_ext_community) then return true;
                if (0, routeserverasn) ~ bgp_community || ((ro,0,routeserverasn) ~ bgp_ext_community) then return false;
        }
                return true;

}

##
## Route Server client configuration
##


